name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build binaries
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: langscan-linux-amd64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: langscan-macos-amd64
          - os: macos-14
            target: aarch64-apple-darwin
            artifact: langscan-macos-arm64

    steps:
      - uses: actions/checkout@v4

      - name: Set version from git tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          perl -i -pe "s/^version = \".*\"/version = \"$VERSION\"/ if /^version = \".*\"/ && !\$done++" Cargo.toml
          cat Cargo.toml

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build
        run: |
          cargo build --release --target ${{ matrix.target }}
          mkdir -p dist
          cp target/${{ matrix.target }}/release/langscan dist/${{ matrix.artifact }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/${{ matrix.artifact }}

  release:
    name: GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*
          generate_release_notes: true

  update-formula:
    name: Update Homebrew Formula
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Update Formula and Cargo.toml
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          REPO="${GITHUB_REPOSITORY}"
          
          # Update Cargo.toml version
          perl -i -pe "s/^version = \".*\"/version = \"$VERSION\"/ if /^version = \".*\"/ && !\$done++" Cargo.toml

          # Update Homebrew Formula
          SHA_LINUX=$(sha256sum artifacts/langscan-linux-amd64/langscan-linux-amd64 | awk '{print $1}')
          SHA_MAC_AMD=$(sha256sum artifacts/langscan-macos-amd64/langscan-macos-amd64 | awk '{print $1}')
          SHA_MAC_ARM=$(sha256sum artifacts/langscan-macos-arm64/langscan-macos-arm64 | awk '{print $1}')

          sed -i "s/version \".*\"/version \"$VERSION\"/" Formula/langscan.rb

          # Use a more reliable way to update specific platform URLs and SHAs
          # Update Linux
          sed -i "/langscan-linux-amd64\"/{n;s/sha256 \".*\"/sha256 \"$SHA_LINUX\"/;}" Formula/langscan.rb
          sed -i "s|url \".*langscan-linux-amd64\"|url \"https://github.com/$REPO/releases/download/v$VERSION/langscan-linux-amd64\"|" Formula/langscan.rb

          # Update macOS Intel
          sed -i "/langscan-macos-amd64\"/{n;s/sha256 \".*\"/sha256 \"$SHA_MAC_AMD\"/;}" Formula/langscan.rb
          sed -i "s|url \".*langscan-macos-amd64\"|url \"https://github.com/$REPO/releases/download/v$VERSION/langscan-macos-amd64\"|" Formula/langscan.rb

          # Update macOS ARM
          sed -i "/langscan-macos-arm64\"/{n;s/sha256 \".*\"/sha256 \"$SHA_MAC_ARM\"/;}" Formula/langscan.rb
          sed -i "s|url \".*langscan-macos-arm64\"|url \"https://github.com/$REPO/releases/download/v$VERSION/langscan-macos-arm64\"|" Formula/langscan.rb

          sed -i "s|homepage \".*\"|homepage \"https://github.com/$REPO\"|" Formula/langscan.rb

          echo "===== UPDATED METADATA ====="
          cat Cargo.toml
          cat Formula/langscan.rb

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/langscan.rb Cargo.toml
          git commit -m "chore: bump version to ${GITHUB_REF_NAME} [skip ci]" || echo "No changes"
          git push origin HEAD:main
